/*

Bugs
• Font-Sizing

Small Enhancements
• Move the hover data to directly above the chart line
• Update the informational text

Medium Enhancements
Create three separate data sets
• Just 2001 and 2011 by debt, with a gradation for debt to gdp
• Expand to all years (more stops on the gradient)
• Show all years

Large Enhancements

*//* global d3 *//* jshint devel:true */// dv is the namespace used to avoid collisions with other code or libraries
var dv={data:{},dato:{},load:{},postload:{},state:{},dim:{},scale:{},html:{},svg:{},create:{},update:{},draw:{},redraw:{},write:{},rewrite:{},calc:{},format:{},util:{}};dv.opt={colors:["#08519c","#4292c6","#6baed6","#789","#74c476","#238b45","#00441b"],data:{years:{first:2e3,last:2011,continuous:!0},countries:{count:20,sortCol:"Debt","default":[]},col:"Debt",height:"Debt",rank:"General government net debt - Percent of GDP",power:1},margin:{left:0,right:0,top:0,bottom:0,label:{left:120,right:120,top:0,bottom:20}},chart:{line:{minHeight:8,pad:16},opacity:{norm:.85,high:1,low:.25},curve:{straight:0,rank:1,change:5,rankCP:.5,changeCP:0}},svg:{mindim:{h:350,w:500}},path:{data:"data/WEO-All.csv",region:"data/regions.csv"},text:{pad:5}};window.onresize=function(){dv.update.resize()};dv.load.data=function(){dv.update.loadState(2);d3.csv(dv.opt.path.data,function(e,t){dv.dato.full=t;dv.update.loadState(-1)});d3.csv(dv.opt.path.region,function(e,t){dv.dato.region={};for(var n=t.length-1;n>=0;n--)dv.dato.region[t[n].Country]=t[n].Region;dv.update.loadState(-1)})};dv.postload.data=function(){dv.create.cleanData();dv.create.countryList();dv.create.subset();dv.create.scales();dv.draw.flowChart();dv.draw.lineLabels()};dv.create.start=function(){dv.create.variables();dv.load.data()};dv.create.variables=function(){dv.data={countries:{all:[],selected:[]},resize:[],years:{first:1980,last:2018,all:[],selected:[]}};dv.dato={full:{},max:{},min:{},sum:{}};dv.create.dims();var e=dv.opt.data.years,t=dv.data.years,n,r;e.continuous&&(t.selected=dv.calc.years(e.first,e.last));t.all=dv.calc.years(t.first,t.last);for(n=t.selected.length-1;n>=0;n--){r=t.selected[n];dv.dato.sum[r]=0;dv.dato.max[r]=0;dv.dato.min[r]=0}};dv.create.dims=function(){var e=dv.opt.margin,t=dv.opt.svg.mindim;dv.html.win=window||document.documentElement||document.getElementsByTagName("body")[0];dv.dim.win={h:dv.html.win.innerHeight||dv.html.win.clientHeight,w:dv.html.win.innerWidth||dv.html.win.clientWidth};dv.html.body=d3.select("body");dv.write.header();dv.write.text();dv.dim.body={top:parseInt(dv.html.body.style("margin-top"),10),right:parseInt(dv.html.body.style("margin-right"),10),bottom:parseInt(dv.html.body.style("margin-bottom"),10),left:parseInt(dv.html.body.style("margin-left"),10)};dv.html.svg=dv.html.svg||dv.draw.svg();dv.dim.svg={h:dv.dim.win.h-e.top-e.bottom-dv.html.svg.offsetTop-dv.dim.body.bottom,w:dv.dim.win.w-e.left-e.right-dv.html.svg.offsetLeft-dv.dim.body.right};dv.dim.svg.h=dv.dim.svg.h<t.h?t.h:dv.dim.svg.h;dv.dim.svg.w=dv.dim.svg.w<t.w?t.w:dv.dim.svg.w;dv.dim.chart={h:dv.dim.svg.h-e.label.top-e.label.bottom,w:dv.dim.svg.w-e.label.left-e.label.right};dv.redraw.svg()};dv.create.cleanData=function(){var e={},t=dv.data.years.all,n,r,i,s,o,u,a,f;for(n=dv.dato.full.length-1;n>=0;n--){i=dv.dato.full[n];o=i.Country;u=i["Subject Descriptor"]+" - "+i.Units;if(!e[o]){e[o]={};e[o].data={};e[o].code=i.ISO;e[o].region=dv.dato.region[o]}e[o].data[u]={};for(r=t.length-1;r>=0;r--){a=t[r];f=i[a]===""?!1:parseFloat(i[a].replace(",",""));i.Units.indexOf("Percent")!==-1&&(f*=.01);e[o].data[u][a]=f}}s=d3.keys(e);dv.data.countries.all=s;dv.dato.full={};dv.data.full=[];for(n=s.length-1;n>=0;n--){o=s[n];e[o].name=o;e[o]=dv.calc.debt(e[o]);dv.dato.full[o]=e[o];dv.data.full.push(e[o])}};dv.create.countryList=function(){function c(e){a=[];dv.data.full=dv.util.sortByData({array:dv.data.full,col:r,year:e});for(u=s;u>s-i;u--)a.push(dv.data.full[u].name);return a}function h(e){o.length<i&&o.indexOf(e)===-1&&o.push(e);return o}var e=dv.data.years.selected,t=e[0],n=e[e.length-1],r=dv.opt.data.countries.sortCol,i=dv.opt.data.countries.count,s=dv.data.countries.all.length-1,o=dv.opt.data.countries.default,u,a,f,l;f=c(t);l=c(n);for(u=0;u<i;u++){o=h(f[u]);o=h(l[u]);o.length>=i&&(u=i)}dv.data.countries.selected=o};dv.create.subset=function(){var e=[],t=dv.data.years.selected,n=dv.data.countries.selected,r=dv.opt.data.col,i=dv.dato.full,s,o,u,a,f,l,c,h;dv.scale.pow=function(e){return Math.pow(e,dv.opt.data.power)};for(s=n.length-1;s>=0;s--){o=n[s];a=i[o];u={};u.name=a.name;u.code=a.code;u.region=a.region;u.data={};u.offset={};u.order={};for(f=t.length-1;f>=0;f--){l=t[f];c=a.data[r][l];u.data[l]=c;h=dv.scale.pow(c);dv.dato.sum[l]+=h;dv.dato.max[l]=d3.max([h,dv.dato.max[l]]);dv.dato.min[l]=d3.min([h,dv.dato.min[l]])}e.push(u)}dv.data.subset=e};dv.create.yscale=function(){dv.dim.yscale=dv.dim.chart.h-dv.data.countries.selected.length*dv.opt.chart.line.pad};dv.create.scales=function(){var e=dv.dim.chart.w,t=dv.opt.chart.line,n=t.minHeight,r=0,i=0,s=dv.data.years.selected,o=dv.data.subset,u,a,f,l,c,h;for(u=s.length-1;u>=0;u--){a=s[u];r=d3.max([dv.dato.sum[a],r]);i=d3.min([dv.dato.min[a],i]);c=0;o=dv.util.sortByData({array:o,year:a});f=o.length;for(l=0;l<f;l++){h=o[l];h.offset[a]=c;h.order[a]=l;c+=dv.scale.pow(h.data[a]);dv.data.subset[l]=h}}dv.create.yscale();dv.scale.x=d3.scale.linear().domain([s[0],s[s.length-1]]).rangeRound([0,e]);dv.scale.y=d3.scale.linear().domain([i,r]).rangeRound([n,dv.dim.yscale]);dv.scale.ypow=function(e){e=dv.scale.pow(e);return dv.scale.y(e)};dv.scale.ylabel=d3.scale.linear().domain([0,1200]).rangeRound([11,16]);dv.scale.xlabel=d3.scale.linear().domain([0,1200]).rangeRound([10,13]);dv.scale.lineLabel=d3.scale.linear().domain([0,1200]).rangeRound([12,15]);dv.scale.header=d3.scale.linear().domain([0,1200]).rangeRound([18,40]);dv.scale.yHigh=function(e,t){return dv.dim.chart.h-dv.scale.y(e.offset[t])-e.order[t]*dv.opt.chart.line.pad-dv.scale.ypow(e.data[t])-dv.opt.text.pad};dv.scale.yLow=function(e,t){return dv.dim.chart.h-dv.scale.y(e.offset[t])-e.order[t]*dv.opt.chart.line.pad};dv.scale.color=d3.scale.ordinal().range(dv.opt.colors)};dv.write.header=function(){dv.html.header=dv.html.body.append("h1").html("Debt to GDP Ratio")};dv.write.text=function(){dv.html.text=dv.html.body.append("div").attr("class","explanation").html("This treemap shows the size of total government debt outstanding across 166 countries worldwide. Each small rectangle shows the size of each bond market, and the larger rectangle shows the size of the regional bond market; the larger the country/region, the further it is towards the bottom left. The colour of each square shows the debt/GDP ratio for that country. We show data here for 2001 and 2011, based on the IMF World Economic Outlook (April 2012) database, using total government debt figures across all currencies. The size of the global bond market is proportional between 2001 and 2011, using 2011 USD. In 2001, the world government bond market was USD 40.11trn in size; as of end-2011, it had reached USD 69.62trn. Despite the growth in Asia ex-Japan (a market that was 60% the size of the euro area in 2001 but is now 7% larger), its debt/GDP ratios remain much lower, reflecting the region’s economic growth.")};dv.draw.svg=function(){var e=dv.opt.margin;dv.svg.svg=dv.html.body.append("svg");dv.svg.main=dv.svg.svg.append("svg:g").attr("transform","translate("+e.left+","+e.top+")");return dv.svg.svg[0][0]};dv.draw.flowChart=function(){function u(e,u,a){dv.svg.paths.transition().duration(250).style("fill-opacity",function(e,n){return n===a?t.high:t.low});o="<h5>"+u.name+"</h5><ul>";r=n.length;for(i=0;i<r;i++){s=n[i];o+="<li><strong>"+s+": </strong>";o+=Math.round(u.data[s]*100)/100+"</li>"}o+="</ul>";dv.redraw.lineLabels(u)}function a(){dv.svg.paths.transition().duration(250).style("fill-opacity",t.norm);dv.svg.lineLabels.transition().duration(250).style("opacity",0)}var e=dv.opt.margin,t=dv.opt.chart.opacity,n=dv.data.years.selected,r,i,s,o;dv.svg.chart=dv.svg.main.append("svg:g");dv.svg.axis=dv.svg.chart.append("svg:g").attr("transform","translate("+e.label.left+","+e.label.top+")").attr("class","vertical-axis").selectAll("rect").data(dv.data.years.selected).enter().append("svg:rect").attr("class",function(e,t){return t%2===0?"even":"odd"}).attr("y",dv.opt.margin.top).style("display",function(e,t){return t===dv.data.years.selected.length-1?"none":!1});dv.redraw.axis();dv.svg.paths=dv.svg.chart.append("svg:g").attr("transform","translate("+dv.opt.margin.label.left+","+dv.opt.margin.label.top+")").selectAll("path").data(dv.data.subset).enter().append("svg:path").style("fill",function(e){return dv.scale.color(e.region)}).style("fill-opacity",t.norm).on("mouseover",function(e,t){u(event,e,t)}).on("mouseout",a);dv.redraw.paths();dv.draw.yLabels("left");dv.draw.yLabels("right");dv.draw.xLabels()};dv.draw.yLabels=function(e){var t,n,r=dv.data.years.selected,i=dv.opt.text.pad,s=dv.opt.margin.label[e]-i,o=dv.opt.margin.label.left;if(e==="left"){o-=i;t="end";n=r[0]}else{o+=dv.dim.chart.w+i;t="begin";n=r[r.length-1]}dv.svg.label=dv.svg.label||{};dv.svg.label[e]={};dv.svg.label[e].g=dv.svg.chart.append("g").attr("transform","translate("+o+",0)");dv.svg.label[e].text=dv.svg.label[e].g.selectAll("text").data(dv.data.subset).enter().append("svg:text").attr("width",s).attr("text-anchor",t).attr("dy",function(t){return dv.calc.labelOffset(t,e)}).text(function(e){return e.name})};dv.draw.xLabels=function(){dv.svg.label=dv.svg.label||{};dv.svg.label.x={};dv.svg.label.x.g=dv.svg.chart.append("g");dv.svg.label.x.text=dv.svg.label.x.g.selectAll("text").data(dv.data.years.selected).enter().append("svg:text").attr("class","xLabel").attr("text-anchor","middle").text(function(e){return e});dv.redraw.xLabels()};dv.draw.flowLine=function(e){function w(e){var t,n=e[0],r=e.length;for(t=1;t<r;t++)n+=","+e[t];return n}function E(e){return" V"+e}function S(e){return" H"+e}function x(e,t,n,r,i,s){return" C"+w([e,t,n,r,i,s])}function T(e){return dv.scale.x(e)}var t=dv.data.years.selected,n=t.length,r="M",i=t[0],s=dv.scale.x(t[1])-dv.scale.x(t[0]),o=dv.opt.chart.curve,u=o.straight+o.rank+o.change,a=s*(o.straight/u),f=s*(o.rank/u),l=s*(o.change/u),c=f*o.rankCP,h=l*o.changeCP,p,d,v,m,g,y,b;i=t[0];p=T(i);d=dv.scale.yLow(e,i);r+=w([p,d]);for(b=0;b<n-1;b++){i=t[b];p=T(i)+a;r+=S(p);v=p+c;m=d;i=t[b+1];p+=f;d=dv.scale.yLow(e,i);g=p-c;y=d;r+=x(v,m,g,y,p,d)}p=T(i);r+=S(p);d=dv.scale.yHigh(e,i);r+=E(d);for(b=n-1;b>0;b--){i=t[b];v=p-h;m=d;i=t[b-1];p-=l;d=dv.scale.yLow(e,i+1)+(dv.scale.yHigh(e,i)-dv.scale.yLow(e,i));g=p+h;y=d;r+=x(v,m,g,y,p,d);v=p-c;m=d;p-=f;d=dv.scale.yHigh(e,i);g=p+c;y=d;r+=x(v,m,g,y,p,d);p=T(i)-a;r+=S(p)}r+=" Z";return r};dv.draw.lineLabels=function(){dv.svg.lineLabels=dv.svg.main.append("svg:g").attr("transform","translate("+dv.opt.margin.label.left+",0)").selectAll("text").data(dv.data.years.selected).enter().append("svg:text").attr("text-anchor","middle")};dv.redraw.lineLabels=function(e){var t=dv.scale.x(dv.data.years.selected[1])-dv.scale.x(dv.data.years.selected[0]),n=dv.scale.lineLabel(dv.dim.chart.w);dv.svg.lineLabels.attr("class","line-label").attr("width",t).style("font-size",n).attr("dx",function(e){return dv.scale.x(e-1)+t/2}).attr("dy",function(t){var n=dv.scale.yHigh(e,t)-5;n<15&&(n=dv.scale.yLow(e,t)+15);return n}).text(function(t){return Math.round(e.data[t])}).style("opacity",0).transition().duration(250).style("opacity",1).style("visibility",function(e,n){return n===0?"hidden":t<40&&n%2===0?"hidden":"visible"})};dv.update.resize=function(){dv.create.dims();dv.create.yscale();dv.scale.x.rangeRound([0,dv.dim.chart.w]);dv.scale.y.rangeRound([dv.opt.chart.line.minHeight,dv.dim.yscale]);dv.redraw.svg();dv.redraw.paths();dv.redraw.yLabels("right");dv.redraw.yLabels("left");dv.redraw.xLabels();dv.redraw.axis()};dv.redraw.svg=function(){dv.svg.svg.attr("width",dv.dim.win.w).attr("height",dv.dim.win.h)};dv.redraw.yLabels=function(e){var t=dv.opt.margin.label.left,n=dv.scale.ylabel(dv.dim.chart.h);e==="left"?t-=dv.opt.text.pad:t+=dv.dim.chart.w+dv.opt.text.pad;dv.svg.label[e].g.attr("transform","translate("+t+",0)");dv.svg.label[e].text.style("font-size",n).attr("dy",function(t){return dv.calc.labelOffset(t,e)})};dv.redraw.xLabels=function(){var e=dv.scale.x(dv.data.years.selected[1])-dv.scale.x(dv.data.years.selected[0]),t=dv.scale.xlabel(dv.dim.chart.w),n=dv.dim.chart.h+t*.5;dv.svg.label.x.g.attr("transform","translate("+dv.opt.margin.label.left+","+n+")");dv.svg.label.x.text.attr("width",e).style("font-size",t).attr("dy",0).attr("dx",function(t){return dv.scale.x(t-1)+e/2}).style("visibility",function(t,n){return n===0?"hidden":e<40&&n%2===0?"hidden":"visible"})};dv.redraw.axis=function(){var e=dv.scale.x(dv.data.years.selected[1])-dv.scale.x(dv.data.years.selected[0]);dv.svg.axis.attr("x",function(e){return dv.calc.axisLabelX(e)}).attr("width",e).attr("height",dv.dim.chart.h-dv.opt.chart.line.minHeight)};dv.redraw.paths=function(){dv.svg.paths.attr("d",function(e){return dv.draw.flowLine(e)})};dv.calc.years=function(e,t){var n=[];for(var r=e;r<t+1;r++)n.push(r);return n};dv.calc.labelOffset=function(e,t){var n,r,i=dv.dim.chart.h,s=dv.data.years.selected;t==="left"?n=s[0]:n=s[s.length-1];r=dv.scale.ypow(e.data[n])/2-5;i-=dv.scale.y(e.offset[n]);i-=e.order[n]*dv.opt.chart.line.pad;i-=r;return i};dv.calc.axisLabelX=function(e){return dv.scale.x(e)};dv.calc.debt=function(e){var t=dv.data.years.all,n,r,i,s;e.data.Debt={};for(n=t.length-1;n>=0;n--){r=t[n];i=e.data["Gross domestic product, current prices - U.S. dollars"][r];s=e.data["General government gross debt - Percent of GDP"][r];i&&s?e.data.Debt[r]=i*s:e.data.Debt[r]=!1}return e};dv.util.sortByData=function(e){e.array.sort(function(t,n){return e.col?t.data[e.col][e.year]-n.data[e.col][e.year]:t.data[e.year]-n.data[e.year]});return e.array};dv.update.loadState=function(e,t){t=t||"data";e=e||1;dv.state[t]=dv.state[t]||0;dv.state[t]+=e;dv.state[t]===0&&dv.postload[t]()};dv.hover=dv.hover||{};dv.hover.show=function(e,t){dv.html.hover||dv.hover.create();var n,r,i,s,o,u=dv.dim.win,a=dv.html.win,f={x:a.scrollX,y:a.scrollY},l=dv.opt.hover||{},c=l.margin||10,h=l.offset||10;if(e&&t){n=e.clientX+h;r=e.clientY-h;i=document.getElementById("hover");dv.html.hover.html(t);s=i.offsetHeight;o=i.offsetWidth;if(n+o+c>=u.w){n=n-2*h-o;n=n<f.x?c:n}if(r+s+c>=u.h){r=u.h-c-s;r=r<f.y?u.h-s-c:r}n+=f.x;r+=f.y;dv.html.hover.style("top",r+"px").style("left",n+"px");dv.html.hover.transition().style("opacity",.95)}};dv.hover.create=function(){dv.html.hover=d3.select("body").append("div").attr("id","hover").style("display","block").attr("visibility","hidden")};dv.hover.hide=function(){dv.html.hover&&dv.html.hover.transition().style("opacity",0)};dv.create.start();