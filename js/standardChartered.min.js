/*
Bugs
• uses total dataset for min/max in scales - should use subset
• add another gradient stop to make it banded instead of gradiented

Small Enhancements
• Update the informational text

Medium Enhancements
Create three separate data sets
• Just 2001 and 2011 by debt, with a gradation for debt to gdp
• Expand to all years (more stops on the gradient)
• Show all years

Large Enhancements

*//* global d3 *//* jshint devel:true */// dv is the namespace used to avoid collisions with other code or libraries
var dv={data:{},dato:{},load:{},postload:{},state:{},dim:{},scale:{},html:{},svg:{},create:{},update:{},draw:{},redraw:{},write:{},rewrite:{},calc:{},format:{},util:{}};dv.opt={color:{twocolor:["#6baed6","#567","#74c476","#00441b","#4292c6","#08519c","#238b45"],contrast:["#660000","#567","#815800","#00441b","#4B178F","#08519c","#238b45"]},gradient:!1,years:{first:2003,last:2013,continuous:!0},countries:{count:20,"default":[]},data:{select:"Gross domestic product, current prices - U.S. dollars",height:"Debt",rank:"General government net debt - Percent of GDP",power:2},format:{height:"GDP",rank:"debt"},path:{data:"data/WEO-All.csv",region:"data/regions.csv"},margin:{left:0,right:0,top:0,bottom:0},label:{left:120,right:120,top:0,bottom:20,pad:5},line:{minHeight:8,pad:16},opacity:{norm:.85,high:1,low:.25},curve:{straight:0,rank:1,change:5,rankCP:.5,changeCP:0},mindim:{h:350,w:500}};window.onresize=function(){dv.update.resize()};dv.load.data=function(){dv.update.loadState(2);d3.csv(dv.opt.path.data,function(e,t){dv.dato.full=t;dv.update.loadState(-1)});d3.csv(dv.opt.path.region,function(e,t){dv.dato.region={};for(var n=t.length-1;n>=0;n--)dv.dato.region[t[n].Country]=t[n].Region;dv.update.loadState(-1)})};dv.postload.data=function(){dv.create.cleanData();dv.create.countryList();dv.create.prescales();dv.create.subset();dv.create.scales();dv.draw.gradients();dv.draw.flowChart();dv.draw.lineLabels()};dv.create.start=function(){dv.create.variables();dv.load.data()};dv.create.variables=function(){dv.data={countries:{all:[],selected:[]},resize:[],years:{first:1980,last:2018,all:[],selected:[]}};dv.dato={full:{},max:{},min:{},sum:{}};dv.opt.colors=dv.opt.color.twocolor;dv.create.dims();dv.create.years()};dv.create.years=function(){var e=dv.opt.years,t=dv.data.years,n,r;e.continuous?t.selected=dv.calc.years(e.first,e.last):t.selected=[e.first,e.last];t.all=dv.calc.years(t.first,t.last);for(n=t.selected.length-1;n>=0;n--){r=t.selected[n];dv.dato.sum[r]=0;dv.dato.max[r]=0;dv.dato.min[r]=0}};dv.create.dims=function(){var e=dv.opt.margin,t=dv.opt.mindim;dv.html.win=window||document.documentElement||document.getElementsByTagName("body")[0];dv.dim.win={h:dv.html.win.innerHeight||dv.html.win.clientHeight,w:dv.html.win.innerWidth||dv.html.win.clientWidth};dv.html.body=d3.select("body");dv.write.header();dv.write.text();dv.dim.body={top:parseInt(dv.html.body.style("margin-top"),10),right:parseInt(dv.html.body.style("margin-right"),10),bottom:parseInt(dv.html.body.style("margin-bottom"),10),left:parseInt(dv.html.body.style("margin-left"),10)};dv.html.svg=dv.html.svg||dv.draw.svg();dv.dim.svg={h:dv.dim.win.h-e.top-e.bottom-dv.html.svg.offsetTop-dv.dim.body.bottom,w:dv.dim.win.w-e.left-e.right-dv.html.svg.offsetLeft-dv.dim.body.right};dv.dim.svg.h=dv.dim.svg.h<t.h?t.h:dv.dim.svg.h;dv.dim.svg.w=dv.dim.svg.w<t.w?t.w:dv.dim.svg.w;dv.dim.chart={h:dv.dim.svg.h-dv.opt.label.top-dv.opt.label.bottom,w:dv.dim.svg.w-dv.opt.label.left-dv.opt.label.right};dv.redraw.svg()};dv.create.cleanData=function(){var e={},t=dv.data.years.all,n,r,i,s,o,u,a,f;for(n=dv.dato.full.length-1;n>=0;n--){i=dv.dato.full[n];o=i.Country;u=i["Subject Descriptor"]+" - "+i.Units;if(!e[o]){e[o]={};e[o].data={};e[o].code=i.ISO;e[o].region=dv.dato.region[o]}e[o].data[u]={};for(r=t.length-1;r>=0;r--){a=t[r];f=i[a]===""?!1:parseFloat(i[a].replace(",",""));i.Units.indexOf("Percent")!==-1&&(f*=.01);e[o].data[u][a]=f}}s=d3.keys(e);dv.data.countries.all=s;dv.dato.full={};dv.data.full=[];for(n=s.length-1;n>=0;n--){o=s[n];e[o].name=o;e[o]=dv.calc.debt(e[o]);dv.dato.full[o]=e[o];dv.data.full.push(e[o])}};dv.create.countryList=function(){function c(e){a=[];dv.data.full=dv.util.aooSort({array:dv.data.full,key:["data",r,e]});for(u=s;u>s-i;u--)a.push(dv.data.full[u].name);return a}function h(e){o.length<i&&o.indexOf(e)===-1&&o.push(e);return o}var e=dv.data.years.selected,t=e[0],n=e[e.length-1],r=dv.opt.data.select,i=dv.opt.countries.count,s=dv.data.countries.all.length-1,o=dv.opt.countries.default,u,a,f,l;f=c(t);l=c(n);for(u=0;u<i;u++){o=h(f[u]);o=h(l[u]);o.length>=i&&(u=i)}dv.data.countries.selected=o};dv.create.subset=function(){var e=[],t=dv.data.countries.selected,n=dv.dato.full,r=!1,i,s,o,u;for(i=t.length-1;i>=0;i--){s=t[i];u=n[s];o={};o.name=u.name;o.code=u.code;o.region=u.region;o.height={};o.rank={};o.offset={};o.order={};i===t.length-1?r=!0:r=!1;o=dv.calc.country(o,r);e.push(o)}dv.data.subset=e;dv.data.sorted=e};dv.update.subset=function(){var e=dv.data.subset,t=!1,n,r;dv.data.sorted=[];for(n=e.length-1;n>=0;n--){r=e[n];n===e.length-1?t=!0:t=!1;r=dv.calc.country(r,t);dv.data.sorted.push(r)}};dv.create.yscale=function(){dv.dim.yscale=dv.dim.chart.h-dv.data.countries.selected.length*dv.opt.line.pad};dv.create.prescales=function(){dv.scale.pow=function(e){return Math.pow(e,dv.opt.data.power)}};dv.create.scales=function(){var e=dv.dim.chart.w,t=dv.opt.line,n=t.minHeight,r=0,i=0,s=0,o=dv.data.years.selected,u=dv.data.subset,a=dv.data.sorted,f,l,c,h,p,d,v,m,g;for(f=o.length-1;f>=0;f--){l=o[f];r=d3.max([dv.dato.sum[l],r]);s=d3.max([dv.dato.max[l],s]);i=d3.min([dv.dato.min[l],i]);p=0;dv.util.aooSort({array:a,key:["rank",l]});c=u.length;for(h=0;h<c;h++){d=a[h];d.offset[l]=p;d.order[l]=h;p+=dv.scale.pow(d.height[l]);v=0;while(v<u.length&&u[v].code!==d.code)v++;dv.data.subset[v]=d}}dv.create.yscale();dv.scale.x=d3.scale.linear().domain([o[0],o[o.length-1]]).rangeRound([0,e]);dv.scale.y=d3.scale.linear().domain([i,r]).rangeRound([n,dv.dim.yscale]);dv.scale.ypow=function(e){e=dv.scale.pow(e);return dv.scale.y(e)};dv.scale.ylabel=d3.scale.linear().domain([0,1200]).rangeRound([12,16]);dv.scale.xlabel=d3.scale.linear().domain([0,1200]).rangeRound([10,13]);dv.scale.lineLabel=d3.scale.linear().domain([0,1200]).rangeRound([12,15]);dv.scale.header=d3.scale.linear().domain([0,1200]).rangeRound([18,40]);dv.scale.yHigh=function(e,t){return dv.dim.chart.h-dv.scale.y(e.offset[t])-e.order[t]*dv.opt.line.pad-dv.scale.ypow(e.height[t])-dv.opt.label.pad};dv.scale.yLow=function(e,t){return dv.dim.chart.h-dv.scale.y(e.offset[t])-e.order[t]*dv.opt.line.pad};dv.scale.color=d3.scale.ordinal().range(dv.opt.colors);dv.scale.grad={};dv.scale.grad.twocolor=d3.scale.linear().range(["#050","#800"]).domain([0,1.2]).clamp(!0);for(f=dv.opt.colors.length-1;f>=0;f--){m=dv.opt.colors[f];dv.scale.grad[m]=d3.scale.linear().range(["#FFF",m]).domain([0,1]);g=dv.scale.grad[m](.5);dv.scale.grad[m].range([g,m])}};dv.write.header=function(){dv.html.header=dv.html.body.append("h1").html("Debt & GDP")};dv.write.text=function(){dv.html.text=dv.html.body.append("div").attr("class","explanation").html("Bar Height: <a href='javascript:dv.update.height.debt(1000)'>Debt</a> | <a href='javascript:dv.update.height.ratio(1000)'>Debt/GDP Ratio</a> :: Bar Order: <a href='javascript:dv.update.rank.debt(1000)'>Debt</a> | <a href='javascript:dv.update.rank.ratio(1000)'>Debt/GDP Ratio</a>")};dv.draw.svg=function(){var e=dv.opt.margin;dv.svg.svg=dv.html.body.append("svg:svg");dv.svg.main=dv.svg.svg.append("svg:g").attr("transform","translate("+e.left+","+e.top+")");return dv.svg.svg[0][0]};dv.draw.flowChart=function(){dv.svg.chart=dv.svg.main.append("svg:g");dv.draw.axis();dv.draw.flowLines();dv.draw.yLabels("left");dv.draw.yLabels("right");dv.draw.xLabels()};dv.draw.axis=function(){dv.svg.axis=dv.svg.chart.append("svg:g").attr("transform","translate("+dv.opt.label.left+","+dv.opt.label.top+")").attr("class","vertical-axis").selectAll("rect").data(dv.data.years.selected).enter().append("svg:rect").attr("class",function(e,t){return t%2===0?"even":"odd"}).attr("y",dv.opt.margin.top).style("display",function(e,t){return t===dv.data.years.selected.length-1?"none":!1});dv.redraw.axis()};dv.draw.flowLines=function(){function e(e,t,n){dv.svg.flowLines.transition().duration(10).style("fill-opacity",function(e,t){return t===n?dv.opt.opacity.high:dv.opt.opacity.low});dv.redraw.lineLabels(t)}function t(){dv.svg.flowLines.transition().duration(250).style("fill-opacity",dv.opt.opacity.norm);dv.svg.lineLabels.transition().duration(250).style("opacity",0)}dv.svg.flowLines=dv.svg.chart.append("svg:g").attr("transform","translate("+dv.opt.label.left+","+dv.opt.label.top+")").selectAll("path").data(dv.data.subset).enter().append("svg:path").style("fill-opacity",dv.opt.opacity.norm).on("mouseover",function(t,n){e(event,t,n)}).on("mouseout",t);dv.redraw.flowLines()};dv.draw.yLabels=function(e){var t,n=dv.opt.label[e]-dv.opt.label.pad;e==="left"?t="end":t="begin";dv.svg.label=dv.svg.label||{};dv.svg.label[e]={};dv.svg.label[e].g=dv.svg.chart.append("g");dv.svg.label[e].text=dv.svg.label[e].g.selectAll("text").data(dv.data.subset).enter().append("svg:text").attr("width",n).attr("text-anchor",t).text(function(e){return e.name});dv.redraw.yLabels(e)};dv.draw.xLabels=function(){dv.svg.label=dv.svg.label||{};dv.svg.label.x={};dv.svg.label.x.g=dv.svg.chart.append("g");dv.svg.label.x.text=dv.svg.label.x.g.selectAll("text").data(dv.data.years.selected).enter().append("svg:text").attr("class","xLabel").attr("text-anchor","middle").text(function(e){return e});dv.redraw.xLabels()};dv.draw.flowLine=function(e){function w(e){var t,n=Math.round(e[0]),r=e.length;for(t=1;t<r;t++)n+=","+Math.round(e[t]);return n}function E(e){return" V"+Math.round(e)}function S(e){return" H"+Math.round(e)}function x(e,t,n,r,i,s){return" C"+w([e,t,n,r,i,s])}function T(e){return dv.scale.x(e)}var t=dv.data.years.selected,n=t.length,r="M",i=t[0],s=dv.scale.x(t[1])-dv.scale.x(t[0]),o=dv.opt.curve,u=o.straight+o.rank+o.change,a=s*(o.straight/u),f=s*(o.rank/u),l=s*(o.change/u),c=f*o.rankCP,h=l*o.changeCP,p,d,v,m,g,y,b;i=t[0];p=T(i);d=dv.scale.yLow(e,i);r+=w([p,d]);for(b=0;b<n-1;b++){i=t[b];p=T(i)+a;r+=S(p);v=p+c;m=d;i=t[b+1];p+=f;d=dv.scale.yLow(e,i);g=p-c;y=d;r+=x(v,m,g,y,p,d)}p=T(i);r+=S(p);d=dv.scale.yHigh(e,i);r+=E(d);for(b=n-1;b>0;b--){i=t[b];v=p-h;m=d;i=t[b-1];p-=l;d=dv.scale.yLow(e,t[b])+(dv.scale.yHigh(e,i)-dv.scale.yLow(e,i));g=p+h;y=d;r+=x(v,m,g,y,p,d);v=p-c;m=d;p-=f;d=dv.scale.yHigh(e,i);g=p+c;y=d;r+=x(v,m,g,y,p,d);p=T(i)-a;r+=S(p)}r+=" Z";return r};dv.draw.lineLabels=function(){dv.svg.lineLabels=dv.svg.main.append("svg:g").attr("transform","translate("+dv.opt.label.left+",0)").selectAll("text").data(dv.data.years.selected).enter().append("svg:text").attr("text-anchor","middle")};dv.draw.gradients=function(){var e,t,n=dv.data.years.selected.length;dv.svg.gradients=dv.svg.main.append("svg:g").selectAll("linearGradient").data(dv.data.subset).enter().append("svg:linearGradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("id",function(r){e=d3.select(this);e.selectAll("stop").data(dv.data.years.selected).enter().append("svg:stop").attr("offset",function(e,t){return Math.round(t/n*100)+"%"}).style("stop-color",function(e){t="twocolor";return dv.scale.grad[t](r.height[e])}).style("stop-opacity",1);return"grad-"+r.code})};dv.update.rank={};dv.update.height={};dv.update.gradient={};dv.update.rank.debt=function(e){dv.opt.data.rank="Debt";dv.opt.format.rank="debt";e&&dv.update.data(e)};dv.update.height.debt=function(e){dv.opt.data.height="Debt";dv.opt.format.height="debt";dv.opt.data.power=1;e&&dv.update.data(e)};dv.update.rank.ratio=function(e){dv.opt.data.rank="General government net debt - Percent of GDP";dv.opt.format.rank="GDP";e&&dv.update.data(e)};dv.update.height.ratio=function(e){dv.opt.data.height="General government net debt - Percent of GDP";dv.opt.format.height="GDP";dv.opt.data.power=2;e&&dv.update.data(e)};dv.update.gradient.none=function(e){dv.opt.colors=["#6baed6","#567","#74c476","#00441b","#4292c6","#08519c","#238b45"];e&&dv.update.data(e)};dv.update.data=function(e){dv.update.subset();dv.create.scales();dv.svg.label.left.text.data(dv.data.subset);dv.svg.label.right.text.data(dv.data.subset);dv.svg.axis.data(dv.data.years.selected);dv.svg.flowLines.data(dv.data.subset);dv.svg.label.x.text.data(dv.data.years.selected);dv.svg.lineLabels.data(dv.data.years.selected);dv.update.resize(e)};dv.update.resize=function(e){e||(e=0);dv.create.dims();dv.create.yscale();dv.scale.x.rangeRound([0,dv.dim.chart.w]);dv.scale.y.rangeRound([dv.opt.line.minHeight,dv.dim.yscale]);dv.redraw.svg();dv.redraw.flowLines(e);dv.redraw.yLabels("right",e);dv.redraw.yLabels("left",e);dv.redraw.xLabels();dv.redraw.axis()};dv.redraw.svg=function(){dv.svg.svg.attr("width",dv.dim.win.w).attr("height",dv.dim.win.h)};dv.redraw.yLabels=function(e,t){var n=dv.opt.label.left,r=dv.scale.ylabel(dv.dim.chart.h);t||(t=0);e==="left"?n-=dv.opt.label.pad:n+=dv.dim.chart.w+dv.opt.label.pad;dv.svg.label[e].g.attr("transform","translate("+n+",0)");dv.svg.label[e].text.transition().duration(t).style("font-size",r).attr("dy",function(t){return dv.calc.labelOffset(t,e)})};dv.redraw.xLabels=function(){var e=dv.scale.x(dv.data.years.selected[1])-dv.scale.x(dv.data.years.selected[0]),t=dv.scale.xlabel(dv.dim.chart.w),n=dv.dim.chart.h+t*.5;dv.svg.label.x.g.attr("transform","translate("+dv.opt.label.left+","+n+")");dv.svg.label.x.text.attr("width",e).style("font-size",t).attr("dy",0).attr("dx",function(t){return dv.scale.x(t-1)+e/2}).style("visibility",function(t,n){return n===0?"hidden":e<40&&n%2===0?"hidden":"visible"})};dv.redraw.axis=function(){var e=dv.scale.x(dv.data.years.selected[1])-dv.scale.x(dv.data.years.selected[0]);dv.svg.axis.attr("x",function(e){return dv.calc.axisLabelX(e)}).attr("width",e).attr("height",dv.dim.chart.h-dv.opt.line.minHeight)};dv.redraw.flowLines=function(e){dv.svg.flowLines.transition().duration(e).style("fill",function(e){return dv.opt.gradient?"url(#grad-"+e.code+")":dv.scale.color(e.region)}).attr("d",function(e){return dv.draw.flowLine(e)})};dv.redraw.lineLabels=function(e){var t=dv.scale.x(dv.data.years.selected[1])-dv.scale.x(dv.data.years.selected[0]),n=dv.scale.lineLabel(dv.dim.chart.h);dv.svg.lineLabels.attr("class","line-label").attr("width",t).style("font-size",n).attr("dx",function(e,n){return dv.scale.x(dv.data.years.selected[n-1])+t/2}).attr("dy",function(t){var n=dv.scale.yHigh(e,t)-5;n<15&&(n=dv.scale.yLow(e,t)+15);return n}).text(function(t){return dv.format[dv.opt.format.height](e.height[t])}).style("opacity",.25).transition().duration(250).style("opacity",1).style("visibility",function(e,n){return n===0?"hidden":t<40&&n%2===0?"hidden":"visible"})};dv.calc.years=function(e,t){var n=[];for(var r=e;r<t+1;r++)n.push(r);return n};dv.calc.labelOffset=function(e,t){var n,r,i=dv.dim.chart.h,s=dv.data.years.selected;t==="left"?n=s[0]:n=s[s.length-1];r=dv.scale.ypow(e.height[n])/2-3;i-=dv.scale.y(e.offset[n]);i-=e.order[n]*dv.opt.line.pad;i-=r;return i};dv.calc.axisLabelX=function(e){return dv.scale.x(e)};dv.calc.debt=function(e){var t=dv.data.years.all,n,r,i,s;e.data.Debt={};for(n=t.length-1;n>=0;n--){r=t[n];i=e.data["Gross domestic product, current prices - U.S. dollars"][r];s=e.data["General government gross debt - Percent of GDP"][r];i&&s?e.data.Debt[r]=i*s:e.data.Debt[r]=!1}return e};dv.format.debt=function(e){e=Math.round(e);if(e<1e3)return"$"+e+"b";e/=100;e=Math.round(e)/10;return"$"+e+"T"};dv.format.GDP=function(e){e=Math.round(e*100)/100;return e};dv.calc.country=function(e,t){var n=dv.data.years.selected,r=dv.dato.full[e.name],i,s,o;for(i=n.length-1;i>=0;i--){s=n[i];e.height[s]=r.data[dv.opt.data.height][s];e.rank[s]=r.data[dv.opt.data.rank][s];o=dv.scale.pow(e.height[s]);if(t){dv.dato.sum[s]=o;dv.dato.max[s]=o;dv.dato.min[s]=o}else{dv.dato.sum[s]+=o;dv.dato.max[s]=d3.max([o,dv.dato.max[s]]);dv.dato.min[s]=d3.min([o,dv.dato.min[s]])}}return e};dv.util.aooSort=function(e){var t,n,r=dv.util.toArray(e.key),i=r.length;e.array.sort(function(s,u){for(t=0;t<i;t++){n=r[t];s=s[n];u=u[n]}e.reverse?s*=-1:u*=-1;return s+u});return e.array};dv.util.toArray=function(e){Object.prototype.toString.call(e)==="string"&&(e=[e]);return e};dv.update.loadState=function(e,t){t=t||"data";e=e||1;dv.state[t]=dv.state[t]||0;dv.state[t]+=e;dv.state[t]===0&&dv.postload[t]()};dv.hover=dv.hover||{};dv.hover.show=function(e,t){dv.html.hover||dv.hover.create();var n,r,i,s,o,u=dv.dim.win,a=dv.html.win,f={x:a.scrollX,y:a.scrollY},l=dv.opt.hover||{},c=l.margin||10,h=l.offset||10;if(e&&t){n=e.clientX+h;r=e.clientY-h;i=document.getElementById("hover");dv.html.hover.html(t);s=i.offsetHeight;o=i.offsetWidth;if(n+o+c>=u.w){n=n-2*h-o;n=n<f.x?c:n}if(r+s+c>=u.h){r=u.h-c-s;r=r<f.y?u.h-s-c:r}n+=f.x;r+=f.y;dv.html.hover.style("top",r+"px").style("left",n+"px");dv.html.hover.transition().style("opacity",.95)}};dv.hover.create=function(){dv.html.hover=d3.select("body").append("div").attr("id","hover").style("display","block").attr("visibility","hidden")};dv.hover.hide=function(){dv.html.hover&&dv.html.hover.transition().style("opacity",0)};dv.create.start();