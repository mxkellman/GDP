/*
Bugs

Small Enhancements
• Update the informational text

Medium Enhancements
Create three separate data sets
• Just 2001 and 2011 by debt, with a gradation for debt to gdp
• Expand to all years (more stops on the gradient)
• Show all years

Large Enhancements

*//* global d3 *//* jshint devel:true */// dv is the namespace used to avoid collisions with other code or libraries
var dv={data:{},dato:{},load:{},postload:{},state:{},dim:{},scale:{},html:{},svg:{},create:{},update:{},draw:{},redraw:{},write:{},rewrite:{},calc:{},format:{},util:{}};dv.opt={colors:["#6baed6","#567","#74c476","#00441b","#4292c6","#08519c","#238b45"],countries:{count:20,"default":["Greece","Argentina"]},data:{select:"Gross domestic product, current prices - U.S. dollars",height:"Gross domestic product, current prices - U.S. dollars",rank:"Gross domestic product, current prices - U.S. dollars",gradient:!1,label:"Gross domestic product, current prices - U.S. dollars",power:1},duration:1e3,format:{label:"bigDollar"},path:{data:"data/WEO-All.csv",region:"data/regions.csv"},margin:{left:0,right:0,top:0,bottom:0},label:{left:120,right:120,top:0,bottom:20,pad:5},line:{minHeight:4,pad:12},opacity:{norm:.85,high:1,low:.25},curve:{straight:0,rank:1,change:5,rankCP:.5,changeCP:0},mindim:{h:350,w:500},text:"",views:[{rank:"Gross domestic product, current prices - U.S. dollars",height:"Gross domestic product, current prices - U.S. dollars",label:"Gross domestic product, current prices - U.S. dollars",format:"bigDollar",gradient:!1,title:"Gross Domestic Product (GDP)",descr:"GDP for the top 20 countries, plus Greece and Argentina, are shown below. The height of each bar shows the relative size of the country's GDP, and the bars are ordered from largest GDP to smallest.",bigLoss:"Smallest total GDP growth",bigGain:"Largest total GDP growth",bigLossYear:"Largest 1yr GDP loss",bigGainYear:"Largest 1yr GDP growth",linkTo:"GDP"},{rank:"Debt",height:"Debt",label:"Debt",format:"bigDollar",gradient:!1,title:"Debt",descr:"The height and order of the bars now shows the gross debt in US Dollars for each country. The height of all of the bars together shows the total debt carried by these countries.",bigLoss:"Largest total drop in debt",bigGain:"Largest total growth in debt",bigLossYear:"Largest 1yr drop in debt",bigGainYear:"Largest 1yr growth in debt",linkTo:"Debt"},{rank:"General government gross debt - Percent of GDP",height:"Debt",label:"General government gross debt - Percent of GDP",format:"percent",gradient:"General government gross debt - Percent of GDP",title:"Debt to GDP Ratio",descr:"The ratio of a country's gross debt to its GDP is an important overall indicator of economic health.  A country that consistently carries more than 60% of its GDP as debt is considered unhealthy and is colored red.",bigLoss:"Largest total drop in Debt/GDP",bigGain:"Largest total rise in Debt/GDP",bigLossYear:"Largest 1yr drop in Debt/GDP",bigGainYear:"Largest 1yr rise in Debt/GDP",linkTo:"Debt to GDP ratio"}],years:{first:2002,last:2013,continuous:!0}};window.onresize=function(){dv.update.resize()};dv.load.data=function(){dv.update.loadState(2);d3.csv(dv.opt.path.data,function(e,t){dv.dato.full=t;dv.update.loadState(-1)});d3.csv(dv.opt.path.region,function(e,t){dv.dato.region={};for(var n=t.length-1;n>=0;n--)dv.dato.region[t[n].Country]=t[n].Region;dv.update.loadState(-1)})};dv.postload.data=function(){dv.create.cleanData();dv.create.countryList();dv.create.prescales();dv.create.subset();dv.update.view();dv.rewrite.stats();dv.create.dims();dv.create.scales();dv.draw.gradients();dv.draw.flowChart();dv.draw.lineLabels();dv.update.resize()};dv.create.start=function(){dv.create.variables();dv.create.years();dv.write.header();dv.load.data()};dv.create.variables=function(){dv.data={countries:{all:[],selected:[]},resize:[],years:{first:1980,last:2018,all:[],selected:[]}};dv.dato={full:{},max:{},min:{},sum:{},maxHeight:{},minHeight:{},maxGradient:{},minGradient:{}};dv.state.view=-1;dv.html.body=d3.select("body")};dv.create.defaultText=function(){var e="",t=" | ";e+="<a href='javascript:dv.update.option1();'>GDP</a>";e+=t;e+="<a href='javascript:dv.update.option2();'>Debt</a>";e+=t;e+="<a href='javascript:dv.update.option3();'>Debt to GDP Ratio</a>";dv.opt.text=e};dv.create.years=function(){var e=dv.opt.years,t=dv.data.years;e.continuous?t.selected=dv.calc.years(e.first,e.last):t.selected=[e.first,e.last];t.all=dv.calc.years(t.first,t.last)};dv.create.dims=function(){var e=dv.opt.margin,t=dv.opt.mindim;dv.html.win=window||document.documentElement||document.getElementsByTagName("body")[0];dv.dim.win={h:dv.html.win.innerHeight||dv.html.win.clientHeight,w:dv.html.win.innerWidth||dv.html.win.clientWidth};dv.dim.body={top:parseInt(dv.html.body.style("margin-top"),10),right:parseInt(dv.html.body.style("margin-right"),10),bottom:parseInt(dv.html.body.style("margin-bottom"),10),left:parseInt(dv.html.body.style("margin-left"),10)};dv.html.svg=dv.html.svg||dv.draw.svg();dv.dim.svg={h:dv.dim.win.h-e.top-e.bottom-dv.html.svg.offsetTop-dv.dim.body.bottom,w:dv.dim.win.w-e.left-e.right-dv.html.svg.offsetLeft-dv.dim.body.right};dv.dim.svg.h=dv.dim.svg.h<t.h?t.h:dv.dim.svg.h;dv.dim.svg.w=dv.dim.svg.w<t.w?t.w:dv.dim.svg.w;dv.dim.chart={h:dv.dim.svg.h-dv.opt.label.top-dv.opt.label.bottom,w:dv.dim.svg.w-dv.opt.label.left-dv.opt.label.right};dv.redraw.svg()};dv.create.cleanData=function(){var e={},t=dv.data.years.all,n,r,i,s,o,u,a,f;for(n=dv.dato.full.length-1;n>=0;n--){i=dv.dato.full[n];o=i.Country;u=i["Subject Descriptor"]+" - "+i.Units;if(!e[o]){e[o]={};e[o].data={};e[o].code=i.ISO;e[o].region=dv.dato.region[o]}e[o].data[u]={};for(r=t.length-1;r>=0;r--){a=t[r];f=i[a]===""?!1:parseFloat(i[a].replace(",",""));i.Units.indexOf("Percent")!==-1&&(f*=.01);e[o].data[u][a]=f}}s=d3.keys(e);dv.data.countries.all=s;dv.dato.full={};dv.data.full=[];for(n=s.length-1;n>=0;n--){o=s[n];e[o].name=o;e[o]=dv.calc.debt(e[o]);dv.dato.full[o]=e[o];dv.data.full.push(e[o])}};dv.create.countryList=function(){function c(e){a=[];dv.data.full=dv.util.aooSort({array:dv.data.full,key:["data",r,e]});for(u=s;u>s-i;u--)a.push(dv.data.full[u].name);return a}function h(e){o.length<i&&o.indexOf(e)===-1&&o.push(e);return o}var e=dv.data.years.selected,t=e[0],n=e[e.length-1],r=dv.opt.data.select,i=dv.opt.countries.count,s=dv.data.countries.all.length-1,o=dv.opt.countries.default,u,a,f,l;f=c(t);l=c(n);for(u=0;u<i;u++){o=h(f[u]);o=h(l[u]);o.length>=i&&(u=i)}dv.data.countries.selected=o};dv.create.subset=function(){var e=[],t=dv.data.countries.selected,n=dv.dato.full,r=!1,i,s,o,u;dv.create.stats();for(i=t.length-1;i>=0;i--){s=t[i];u=n[s];o={};o.name=u.name;o.code=u.code;o.region=u.region;o.height={};o.rank={};o.offset={};o.order={};o.gradient={};o.label={};i===t.length-1?r=!0:r=!1;o=dv.update.country(o,r);e.push(o)}dv.data.subset=e;dv.data.sorted=e};dv.create.yscale=function(){dv.dim.yscale=dv.dim.chart.h-dv.data.countries.selected.length*dv.opt.line.pad};dv.create.prescales=function(){dv.scale.pow=function(e){return Math.pow(e,dv.opt.data.power)}};dv.create.scales=function(){var e=dv.dim.chart.w,t=dv.opt.line,n=0,r=0,i=0,s=0,o=0,u=0,a=0,f=dv.data.years.selected,l=dv.data.subset,c=dv.data.sorted,h,p,d,v,m,g,y;for(h=f.length-1;h>=0;h--){p=f[h];n=d3.max([dv.dato.sum[p],n]);r=d3.max([dv.dato.max[p],r]);i=d3.min([dv.dato.min[p],i]);s=d3.max([dv.dato.maxHeight[p],s]);o=d3.min([dv.dato.minHeight[p],o]);u=d3.max([dv.dato.maxGradient[p],u]);a=d3.min([dv.dato.minGradient[p],a]);m=0;dv.util.aooSort({array:c,key:["rank",p]});d=l.length;for(v=0;v<d;v++){g=c[v];g.offset[p]=m;g.order[p]=v;m+=dv.scale.pow(g.height[p]);y=0;while(y<l.length&&l[y].code!==g.code)y++;dv.data.subset[y]=g}}dv.create.yscale();dv.scale.x=d3.scale.linear().domain([f[0],f[f.length-1]]).rangeRound([0,e]);dv.scale.y=d3.scale.linear().domain([i,n]).rangeRound([t.minHeight,dv.dim.yscale]);dv.scale.ypow=function(e){e=dv.scale.pow(e);return dv.scale.y(e)};dv.scale.ylabel=d3.scale.linear().domain([0,1200]).rangeRound([12,16]);dv.scale.xlabel=d3.scale.linear().domain([0,1200]).rangeRound([10,13]);dv.scale.lineLabel=d3.scale.linear().domain([0,1200]).rangeRound([12,15]);dv.scale.header=d3.scale.linear().domain([0,1200]).rangeRound([18,40]);dv.scale.yHigh=function(e,t){return dv.dim.chart.h-dv.scale.y(e.offset[t])-e.order[t]*dv.opt.line.pad-dv.scale.ypow(e.height[t])-dv.opt.label.pad};dv.scale.yLow=function(e,t){return dv.dim.chart.h-dv.scale.y(e.offset[t])-e.order[t]*dv.opt.line.pad};dv.scale.color=d3.scale.ordinal().range(dv.opt.colors);dv.scale.gradient=d3.scale.sqrt().range(["#050","#800"]).domain([a,u]).clamp(!0);dv.opt.data.gradient==="General government gross debt - Percent of GDP"&&dv.scale.gradient.range(["#050","#555","#500","#900"]).domain([0,.6,1,u])};dv.create.stats=function(){dv.data.sorted=[];dv.data.stats={};dv.data.stats.bigGain={name:"",val:0};dv.data.stats.bigLoss={name:"",val:0};dv.data.stats.bigGainYear={name:"",val:0,year:0};dv.data.stats.bigLossYear={name:"",val:0,year:0}};dv.write.html=function(e){e.target||(e.target=dv.html.body);if(e.name&&e.type){dv.html[e.name]=e.target.append(e.type);e.css||(e.css=e.name);dv.html[e.name].attr("class",e.css);e.html&&dv.html[e.name].html(e.html)}};dv.write.header=function(){dv.write.html({name:"header",type:"div"});dv.write.html({name:"title",type:"h1",html:"GDP & Debt",target:dv.html.header});dv.write.html({name:"subTitle",type:"h5",target:dv.html.header});dv.write.html({name:"linkTo",type:"a",target:dv.html.header});dv.html.linkTo.on("click",function(){return dv.update.view(dv.opt.duration)});dv.write.html({name:"descr",type:"div",target:dv.html.header});dv.write.html({name:"stats",type:"div",target:dv.html.header});dv.write.html({name:"bigLoss",type:"div",css:"stat",target:dv.html.stats});dv.write.html({name:"bigGain",type:"div",css:"stat",target:dv.html.stats});dv.write.html({name:"bigLossYear",type:"div",css:"stat",target:dv.html.stats});dv.write.html({name:"bigGainYear",type:"div",css:"stat",target:dv.html.stats});dv.html.stats.selectAll(".stat").append("div").attr("class","number");dv.html.stats.selectAll(".stat").append("div").attr("class","country");dv.html.stats.selectAll(".stat").append("div").attr("class","descr")};dv.draw.svg=function(){var e=dv.opt.margin;dv.svg.svg=dv.html.body.append("svg:svg");dv.svg.main=dv.svg.svg.append("svg:g").attr("transform","translate("+e.left+","+e.top+")");return dv.svg.svg[0][0]};dv.draw.flowChart=function(){dv.svg.chart=dv.svg.main.append("svg:g");dv.draw.axis();dv.draw.flowLines();dv.draw.yLabels("left");dv.draw.yLabels("right");dv.draw.xLabels()};dv.draw.axis=function(){dv.svg.axis=dv.svg.chart.append("svg:g").attr("transform","translate("+dv.opt.label.left+","+dv.opt.label.top+")").attr("class","vertical-axis").selectAll("rect").data(dv.data.years.selected).enter().append("svg:rect").attr("class",function(e,t){return t%2===0?"even":"odd"}).attr("y",dv.opt.margin.top).style("display",function(e,t){return t===dv.data.years.selected.length-1?"none":!1})};dv.draw.flowLines=function(){function e(e,t,n){dv.svg.flowLines.transition().duration(10).style("fill-opacity",function(e,t){return t===n?dv.opt.opacity.high:dv.opt.opacity.low});d3.selectAll("."+t.code).style("font-weight","400").style("fill","#222");dv.redraw.lineLabels(t)}function t(){dv.svg.flowLines.transition().duration(250).style("fill-opacity",dv.opt.opacity.norm);dv.svg.lineLabels.transition().duration(250).style("opacity",0);dv.svg.label.left.text.style("font-weight","300").style("fill","#555");dv.svg.label.right.text.style("font-weight","300").style("fill","#555")}dv.svg.flowLines=dv.svg.chart.append("svg:g").attr("transform","translate("+dv.opt.label.left+","+dv.opt.label.top+")").selectAll("path").data(dv.data.subset).enter().append("svg:path").style("fill-opacity",dv.opt.opacity.norm).on("mouseover",function(t,n){e(event,t,n)}).on("mouseout",t)};dv.draw.yLabels=function(e){var t,n=dv.opt.label[e]-dv.opt.label.pad;e==="left"?t="end":t="begin";dv.svg.label=dv.svg.label||{};dv.svg.label[e]={};dv.svg.label[e].g=dv.svg.chart.append("g");dv.svg.label[e].text=dv.svg.label[e].g.selectAll("text").data(dv.data.subset).enter().append("svg:text").attr("class",function(e){return e.code}).attr("width",n).attr("text-anchor",t).text(function(e){return e.name})};dv.draw.xLabels=function(){dv.svg.label=dv.svg.label||{};dv.svg.label.x={};dv.svg.label.x.g=dv.svg.chart.append("g");dv.svg.label.x.text=dv.svg.label.x.g.selectAll("text").data(dv.data.years.selected).enter().append("svg:text").attr("class","xLabel").attr("text-anchor","middle").text(function(e){return e})};dv.draw.flowLine=function(e){function w(e){var t,n=Math.round(e[0]),r=e.length;for(t=1;t<r;t++)n+=","+Math.round(e[t]);return n}function E(e){return" V"+Math.round(e)}function S(e){return" H"+Math.round(e)}function x(e,t,n,r,i,s){return" C"+w([e,t,n,r,i,s])}function T(e){return dv.scale.x(e)}var t=dv.data.years.selected,n=t.length,r="M",i=t[0],s=dv.scale.x(t[1])-dv.scale.x(t[0]),o=dv.opt.curve,u=o.straight+o.rank+o.change,a=s*(o.straight/u),f=s*(o.rank/u),l=s*(o.change/u),c=f*o.rankCP,h=l*o.changeCP,p,d,v,m,g,y,b;i=t[0];p=T(i);d=dv.scale.yLow(e,i);r+=w([p,d]);for(b=0;b<n-1;b++){i=t[b];p=T(i)+a;r+=S(p);v=p+c;m=d;i=t[b+1];p+=f;d=dv.scale.yLow(e,i);g=p-c;y=d;r+=x(v,m,g,y,p,d)}p=T(i);r+=S(p);d=dv.scale.yHigh(e,i);r+=E(d);for(b=n-1;b>0;b--){i=t[b];v=p-h;m=d;i=t[b-1];p-=l;d=dv.scale.yLow(e,t[b])+(dv.scale.yHigh(e,i)-dv.scale.yLow(e,i));g=p+h;y=d;r+=x(v,m,g,y,p,d);v=p-c;m=d;p-=f;d=dv.scale.yHigh(e,i);g=p+c;y=d;r+=x(v,m,g,y,p,d);p=T(i)-a;r+=S(p)}r+=" Z";return r};dv.draw.lineLabels=function(){dv.svg.lineLabels=dv.svg.main.append("svg:g").attr("transform","translate("+dv.opt.label.left+",0)").selectAll("text").data(dv.data.years.selected).enter().append("svg:text").attr("text-anchor","middle")};dv.draw.gradients=function(){var e,t=dv.data.years.selected.length;dv.svg.gradients=dv.svg.main.append("svg:g").selectAll("linearGradient").data(dv.data.subset).enter().append("svg:linearGradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("id",function(n){e=d3.select(this);e.selectAll("stop").data(dv.data.years.selected).enter().append("svg:stop").attr("offset",function(e,n){return Math.round(n/t*100)+"%"}).style("stop-opacity",1);return"grad-"+n.code})};dv.update.view=function(e){dv.state.view=dv.calc.nextView();var t=dv.opt.views[dv.state.view],n=dv.calc.nextView(),r=dv.opt.views[n].linkTo;n===0?r="Start Over with "+r:r="Show changes in "+r;dv.opt.data.rank=t.rank;dv.opt.data.height=t.height;dv.opt.data.gradient=t.gradient;dv.opt.data.label=t.label;dv.opt.format.label=t.format;e&&dv.update.data(e);dv.rewrite.fadeInOut({ele:dv.html.subTitle,duration:e,html:t.title});dv.rewrite.fadeInOut({ele:dv.html.descr,duration:e,html:t.descr});dv.rewrite.fadeInOut({ele:dv.html.linkTo,duration:e,html:r});dv.rewrite.stats(e)};dv.update.data=function(e){dv.update.subset();dv.create.scales();dv.svg.label.left.text.data(dv.data.subset);dv.svg.label.right.text.data(dv.data.subset);dv.svg.axis.data(dv.data.years.selected);dv.svg.flowLines.data(dv.data.subset);dv.svg.label.x.text.data(dv.data.years.selected);dv.svg.lineLabels.data(dv.data.years.selected);dv.update.resize(e)};dv.update.resize=function(e){e||(e=0);dv.create.yscale();dv.create.dims();dv.scale.x.rangeRound([0,dv.dim.chart.w]);dv.scale.y.rangeRound([dv.opt.line.minHeight,dv.dim.yscale]);dv.redraw.svg();dv.redraw.flowLines(e);dv.redraw.gradients(e);dv.redraw.yLabels("right",e);dv.redraw.yLabels("left",e);dv.redraw.xLabels();dv.redraw.axis()};dv.update.subset=function(){var e=dv.data.subset,t=!1,n,r;dv.create.stats();for(n=e.length-1;n>=0;n--){r=e[n];n===e.length-1?t=!0:t=!1;r=dv.update.country(r,t);dv.data.sorted.push(r)}};dv.update.country=function(e,t){var n=dv.data.years.selected,r=dv.dato.full[e.name],i=dv.data.stats.bigLoss,s=dv.data.stats.bigGain,o=dv.data.stats.bigLossYear,u=dv.data.stats.bigGainYear,a,f,l,c,h,p,d,v;for(a=n.length-1;a>=0;a--){f=n[a];e.height[f]=r.data[dv.opt.data.height][f];e.rank[f]=r.data[dv.opt.data.rank][f];dv.opt.data.gradient?e.gradient[f]=r.data[dv.opt.data.gradient][f]:e.gradient[f]=0;c=r.data[dv.opt.data.label][f];e.label[f]=dv.format[dv.opt.format.label](c);l=e.height[f];h=dv.scale.pow(l);p=e.gradient[f];if(t){dv.dato.sum[f]=h;dv.dato.max[f]=h;dv.dato.min[f]=h;dv.dato.maxHeight[f]=l;dv.dato.minHeight[f]=l;dv.dato.maxGradient[f]=p;dv.dato.minGradient[f]=p}else{dv.dato.sum[f]+=h;dv.dato.max[f]=d3.max([h,dv.dato.max[f]]);dv.dato.min[f]=d3.min([h,dv.dato.min[f]]);dv.dato.maxHeight[f]=d3.max([l,dv.dato.maxHeight[f]]);dv.dato.minHeight[f]=d3.min([l,dv.dato.minHeight[f]]);dv.dato.maxGradient[f]=d3.max([p,dv.dato.maxGradient[f]]);dv.dato.minGradient[f]=d3.min([p,dv.dato.minGradient[f]])}if(a!==0){d=c-r.data[dv.opt.data.label][n[a-1]];if(d<o.val||o.val===0){o.name=e.name;o.val=d;o.year=f}if(d>u.val||u.val===0){u.name=e.name;u.val=d;u.year=f}}}v=r.data[dv.opt.data.label][n[n.length-1]]-r.data[dv.opt.data.label][n[1]];if(v<i.val||i.val===0){i.name=e.name;i.val=v}if(v>s.val||s.val===0){s.name=e.name;s.val=v}return e};dv.redraw.svg=function(){dv.svg.svg.attr("width",dv.dim.svg.w).attr("height",dv.dim.svg.h)};dv.redraw.yLabels=function(e,t){var n=dv.opt.label.left,r=dv.scale.ylabel(dv.dim.chart.h);t||(t=0);e==="left"?n-=dv.opt.label.pad:n+=dv.dim.chart.w+dv.opt.label.pad;dv.svg.label[e].g.attr("transform","translate("+n+",0)");dv.svg.label[e].text.transition().duration(t).style("font-size",r).attr("dy",function(t){return dv.calc.labelOffset(t,e)})};dv.redraw.xLabels=function(){var e=dv.scale.x(dv.data.years.selected[1])-dv.scale.x(dv.data.years.selected[0]),t=dv.scale.xlabel(dv.dim.chart.w),n=dv.dim.chart.h+t*.5;dv.svg.label.x.g.attr("transform","translate("+dv.opt.label.left+","+n+")");dv.svg.label.x.text.attr("width",e).style("font-size",t).attr("dy",0).attr("dx",function(t){return dv.scale.x(t-1)+e/2}).style("visibility",function(t,n){return n===0?"hidden":e<40&&n%2===0?"hidden":"visible"})};dv.redraw.axis=function(){var e=dv.scale.x(dv.data.years.selected[1])-dv.scale.x(dv.data.years.selected[0]);dv.svg.axis.attr("x",function(e){return dv.calc.axisLabelX(e)}).attr("width",e).attr("height",dv.dim.chart.h-dv.opt.line.minHeight)};dv.redraw.flowLines=function(e){dv.svg.flowLines.style("pointer-events","none");dv.svg.flowLines.transition().duration(e).style("fill",function(e){return"url(#grad-"+e.code+")"}).attr("d",function(e){return dv.draw.flowLine(e)}).each("end",function(){dv.svg.flowLines.style("pointer-events","auto")})};dv.redraw.lineLabels=function(e){var t=dv.scale.x(dv.data.years.selected[1])-dv.scale.x(dv.data.years.selected[0]),n=dv.scale.lineLabel(dv.dim.chart.h);dv.svg.lineLabels.attr("class","line-label").attr("width",t).style("font-size",n).attr("dx",function(e,n){return dv.scale.x(dv.data.years.selected[n-1])+t/2}).attr("dy",function(t){var n=dv.scale.yHigh(e,t)-5;n<15&&(n=dv.scale.yLow(e,t)+15);return n}).text(function(t){return e.label[t]}).style("opacity",.25).transition().duration(250).style("opacity",1).style("visibility",function(e,n){return n===0?"hidden":t<40&&n%2===0?"hidden":"visible"})};dv.redraw.gradients=function(e){var t;dv.svg.gradients.attr("",function(n){t=d3.select(this);t.selectAll("stop").transition().duration(e).style("stop-color",function(e){return dv.opt.data.gradient?dv.scale.gradient(n.gradient[e]):dv.scale.color(n.region)})})};dv.rewrite.fadeInOut=function(e){e.duration?e.ele.transition().duration(e.duration/2).style("opacity",0).transition().duration(0).each("end",function(){d3.select(this).html(e.html).transition().duration(e.duration/2).style("opacity",1)}):e.ele.html(e.html).style("opacity",1)};dv.rewrite.stats=function(e){var t=dv.opt.views[dv.state.view],n;n=dv.format[t.format](dv.data.stats.bigLoss.val);t.format!=="percent"&&(n+=dv.calc.dif(dv.data.stats.bigLoss));dv.rewrite.fadeInOut({ele:dv.html.bigLoss.select(".number"),duration:e,html:n});dv.rewrite.fadeInOut({ele:dv.html.bigLoss.select(".country"),duration:e,html:dv.data.stats.bigLoss.name});dv.rewrite.fadeInOut({ele:dv.html.bigLoss.select(".descr"),duration:e,html:t.bigLoss});n=dv.format[t.format](dv.data.stats.bigGain.val);t.format!=="percent"&&(n+=dv.calc.dif(dv.data.stats.bigGain));dv.rewrite.fadeInOut({ele:dv.html.bigGain.select(".number"),duration:e,html:n});dv.rewrite.fadeInOut({ele:dv.html.bigGain.select(".country"),duration:e,html:dv.data.stats.bigGain.name});dv.rewrite.fadeInOut({ele:dv.html.bigGain.select(".descr"),duration:e,html:t.bigGain});n=dv.format[t.format](dv.data.stats.bigLossYear.val);t.format!=="percent"&&(n+=dv.calc.dif(dv.data.stats.bigLossYear));dv.rewrite.fadeInOut({ele:dv.html.bigLossYear.select(".number"),duration:e,html:n});dv.rewrite.fadeInOut({ele:dv.html.bigLossYear.select(".country"),duration:e,html:dv.data.stats.bigLossYear.name+" ("+dv.data.stats.bigLossYear.year+")"});dv.rewrite.fadeInOut({ele:dv.html.bigLossYear.select(".descr"),duration:e,html:t.bigLossYear});n=dv.format[t.format](dv.data.stats.bigGainYear.val);t.format!=="percent"&&(n+=dv.calc.dif(dv.data.stats.bigGainYear));dv.rewrite.fadeInOut({ele:dv.html.bigGainYear.select(".number"),duration:e,html:n});dv.rewrite.fadeInOut({ele:dv.html.bigGainYear.select(".country"),duration:e,html:dv.data.stats.bigGainYear.name+" ("+dv.data.stats.bigGainYear.year+")"});dv.rewrite.fadeInOut({ele:dv.html.bigGainYear.select(".descr"),duration:e,html:t.bigGainYear})};dv.calc.dif=function(e){var t,n,r,i,s,o=dv.dato.full[e.name],u=dv.opt.data.label;if(e.year){t=dv.data.years.selected[dv.data.years.selected.indexOf(e.year)-1];n=e.year}else{t=dv.data.years.selected[1];n=dv.data.years.selected[dv.data.years.selected.length-1]}r=o.data[u][t];i=o.data[u][n];s=Math.round((i-r)/r*100);s=' <span class="pct">('+s+"%)</span>";return s};dv.calc.years=function(e,t){var n=[];for(var r=e;r<t+1;r++)n.push(r);return n};dv.calc.labelOffset=function(e,t){var n,r,i=dv.dim.chart.h,s=dv.data.years.selected;t==="left"?n=s[0]:n=s[s.length-1];r=dv.scale.ypow(e.height[n])/2-3;i-=dv.scale.y(e.offset[n]);i-=e.order[n]*dv.opt.line.pad;i-=r;return i};dv.calc.axisLabelX=function(e){return dv.scale.x(e)};dv.calc.debt=function(e){var t=dv.data.years.all,n,r,i,s;e.data.Debt={};for(n=t.length-1;n>=0;n--){r=t[n];i=e.data["Gross domestic product, current prices - U.S. dollars"][r];s=e.data["General government gross debt - Percent of GDP"][r];i&&s?e.data.Debt[r]=i*s:e.data.Debt[r]=!1}return e};dv.calc.nextView=function(){return(dv.state.view+1)%dv.opt.views.length};dv.format.ratio=function(e){var t;e=Math.round(e*100)/100;return e};dv.format.percent=function(e){e=Math.round(e*100);return e+"%"};dv.format.bigDollar=function(e){var t=1,n="",r="$",i=Math.abs(e);if(i<999)n="B";else{t=1e3;n="T"}i=i>999?Math.round(i/t*10)/10:Math.round(i/t);e=e<0?"-"+r+i:r+i;return e+n};dv.format.raw=function(e){return e};dv.util.aooSort=function(e){var t,n,r=dv.util.toArray(e.key),i=r.length;e.array.sort(function(s,u){for(t=0;t<i;t++){n=r[t];s=s[n];u=u[n]}e.reverse?s*=-1:u*=-1;return s+u});return e.array};dv.util.toArray=function(e){Object.prototype.toString.call(e)==="string"&&(e=[e]);return e};dv.update.loadState=function(e,t){t=t||"data";e=e||1;dv.state[t]=dv.state[t]||0;dv.state[t]+=e;dv.state[t]===0&&dv.postload[t]()};dv.create.start();