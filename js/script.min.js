/*

Bugs
• Sizing

Small Enhancements
• Resizing

Medium Enhancements


Large Enhancements

*//* global d3 *//* jshint devel:true */// dv is the namespace used to avoid collisions with other code or libraries
// all static variables and object placeholders
var dv={calc:{},clear:{},create:{},data:{countries:{all:[],selected:[]},full:{arr:[],obj:{}},max:{},min:{},sum:{},years:{first:1980,last:2018,all:[],selected:[]}},dim:{w:window.innerWidth||document.documentElement.clientWidth||document.getElementsByTagName("body")[0].clientWidth,h:window.innerHeight||document.documentElement.clientHeight||document.getElementsByTagName("body")[0].clientHeight},draw:{},format:{},get:{},setup:{},scale:{},state:{loading:0},svg:{},update:{loading:function(e){dv.state.loading+=e;dv.state.loading===0&&dv.setup.withData()}},util:{}};dv.opt={colors:["#00922B","#75B3D6","#444444","#700000","#0078AE","#e08214","#8073ac","#f768a1"],data:{years:{first:2001,last:2011,continuous:!0},countries:{count:10,sortCol:"Debt","default":["South Africa"],percentMin:.5},col:"General government gross debt - Percent of GDP",power:2,calc:function(e){var t=dv.data.years.all,n,r,i,s;e.data.Debt={};for(n=t.length-1;n>=0;n--){r=t[n];i=e.data["Gross domestic product, current prices - U.S. dollars"][r];s=e.data["General government gross debt - Percent of GDP"][r];i&&s?e.data.Debt[r]=i*s:e.data.Debt[r]=!1}return e}},margin:{top:50,right:50,bottom:50,left:50,label:{left:50,right:50}},chart:{h:1,w:1,line:{minHeight:3,pad:10,tangent:.4},opacity:{norm:.8,high:1,low:.5}},path:{data:"data/WEO-All.csv",region:"data/regions.csv"}};dv.setup.variables=function(){var e=dv.opt.data.years,t=dv.data.years,n=dv.opt.margin,r,i;e.continuous&&(dv.data.years.selected=dv.calc.years(e.first,e.last));dv.data.years.all=dv.calc.years(t.first,t.last);for(r=t.selected.length-1;r>=0;r--){i=t.selected[r];dv.data.sum[i]=0;dv.data.max[i]=0;dv.data.min[i]=0}dv.dim.h-=n.top;dv.dim.w-=n.right;dv.dim.min=dv.dim.w<dv.dim.h?dv.dim.w:dv.dim.h;dv.svg.main=d3.select("body").append("svg").attr("width",dv.dim.w).attr("height",dv.dim.h).append("svg:g").attr("height",dv.dim.h).attr("width",dv.dim.w).attr("transform","translate("+n.left+",0)");dv.dim.chart={h:dv.dim.h*dv.opt.chart.h,w:dv.dim.w*dv.opt.chart.w};dv.scale.pow=function(e){return Math.pow(e,dv.opt.data.power)};dv.scale.color=d3.scale.ordinal().range(dv.opt.colors)};dv.setup.withoutData=function(){dv.setup.variables();dv.get.data()};dv.setup.withData=function(){dv.create.cleanData();dv.create.countryList();dv.create.subset();dv.create.scales();dv.draw.flowChart()};dv.get.data=function(){dv.update.loading(2);d3.csv(dv.opt.path.data,function(e,t){dv.data.full.obj=t;dv.update.loading(-1)});d3.csv(dv.opt.path.region,function(e,t){dv.data.region={};for(var n=t.length-1;n>=0;n--)dv.data.region[t[n].Country]=t[n].Region;dv.update.loading(-1)})};dv.create.cleanData=function(){var e={},t=dv.data.years.all,n,r,i,s,o,u,a,f;for(n=dv.data.full.obj.length-1;n>=0;n--){i=dv.data.full.obj[n];o=i.Country;u=i["Subject Descriptor"]+" - "+i.Units;if(!e[o]){e[o]={};e[o].data={};e[o].code=i.ISO;e[o].region=dv.data.region[o]}e[o].data[u]={};for(r=t.length-1;r>=0;r--){a=t[r];f=i[a]===""?!1:parseFloat(i[a].replace(",",""));i.Units.indexOf("Percent")!==-1&&(f*=.01);e[o].data[u][a]=f}}s=d3.keys(e);dv.data.countries.all=s;dv.data.full.obj={};dv.data.full.arr=[];for(n=s.length-1;n>=0;n--){o=s[n];e[o].name=o;e[o]=dv.opt.data.calc(e[o]);dv.data.full.obj[o]=e[o];dv.data.full.arr.push(e[o])}};dv.create.countryList=function(){function c(e){a=[];dv.data.full.arr=dv.util.sortByData({array:dv.data.full.arr,col:r,year:e});for(u=s;u>s-i;u--)a.push(dv.data.full.arr[u].name);return a}function h(e){o.length<i&&o.indexOf(e)===-1&&o.push(e);return o}var e=dv.data.years.selected,t=e[0],n=e[e.length-1],r=dv.opt.data.countries.sortCol,i=dv.opt.data.countries.count,s=dv.data.countries.all.length-1,o=dv.opt.data.countries.default,u,a,f,l;f=c(t);l=c(n);for(u=0;u<i;u++){o=h(f[u]);o=h(l[u]);o.length>=i&&(u=i)}dv.data.countries.selected=o};dv.create.subset=function(){var e=[],t=dv.data.years.selected,n=dv.data.countries.selected,r=dv.opt.data.col,i=dv.data.full.obj,s,o,u,a,f,l,c,h;for(s=n.length-1;s>=0;s--){o=n[s];a=i[o];u={};u.name=a.name;u.code=a.code;u.region=a.region;u.data={};u.offset={};u.order={};for(f=t.length-1;f>=0;f--){l=t[f];c=a.data[r][l];u.data[l]=c;h=dv.scale.pow(c);dv.data.sum[l]+=h;dv.data.max[l]=d3.max([h,dv.data.max[l]]);dv.data.min[l]=d3.min([h,dv.data.min[l]])}e.push(u)}dv.data.subset=e};dv.create.scales=function(){var e=dv.dim.chart.h,t=dv.opt.chart.line.pad,n=dv.opt.chart.line.minHeight,r=dv.opt.data.countries.percentMin,i=dv.dim.chart.w,s=dv.opt.margin.label,o=0,u=0,a=dv.data.years.selected,f=dv.data.countries.selected.length,l=dv.data.subset,c,h,p,d,v,m;dv.scale.x=d3.scale.ordinal().domain(a).rangeRoundBands([s.left,i-s.left-s.right]);for(c=a.length-1;c>=0;c--){h=a[c];o=d3.max([dv.data.sum[h],o]);u=d3.min([dv.data.min[h],u]);v=0;l=dv.util.sortByData({array:l,year:h});p=l.length;for(d=0;d<p;d++){m=l[d];m.offset[h]=v;m.order[h]=d;v+=dv.scale.pow(m.data[h]);dv.data.subset[d]=m}}e-=f*t;e-=f*r*n;dv.scale.y=d3.scale.linear().domain([u,o]).range([n,e]);dv.scale.ypow=function(e){e=dv.scale.pow(e);return dv.scale.y(e)}};dv.draw.flowChart=function(){function b(n){p=e[n];if(n==="left"){d=p-3;g="end";m=f}else{d=r-e.right+3;g="begin";m=l}dv.svg.chart.append("g").style("width",p).style("height",t).selectAll("text").data(s).enter().append("svg:text").attr("text-anchor",g).attr("dx",d).attr("dy",function(e){var n=t,r=dv.scale.ypow(e.data[m])/3;r=r<o?1:r;n-=dv.scale.y(e.offset[m]);n-=e.order[m]*u;n-=r;return n}).text(function(e){return e.name})}function w(e,t,n){dv.svg.paths.style("fill-opacity",function(e,t){return t===n?i.high:i.low});S(e,t,n)}function E(e){dv.svg.paths.style("fill-opacity",i.norm);x(e)}function S(e,t){y="<h5>"+t.name+"</h5><ul>";h=e.pageY;for(v=a.length-1;v>=0;v--){m=a[v];y+="<li><strong>"+m+": </strong>";y+=Math.round(t.data[m]*100)/100+"</li>"}y+="</ul>";h+200>dv.dim.h?h=dv.dim.h-200:h-=20;dv.svg.hover.style("top",h+"px").style("left",e.pageX+20+"px").html(y).style("display","block")}function x(){dv.svg.hover.style("display","none")}var e=dv.opt.margin.label,t=dv.dim.chart.h,n=dv.dim.chart.w,r=dv.dim.chart.w-e.right-e.left,i=dv.opt.chart.opacity,s=dv.data.subset,o=dv.opt.chart.line.minHeight,u=dv.opt.chart.line.pad,a=dv.data.years.selected,f=a[0],l=a[a.length-1],c=dv.svg.main,h,p,d,v,m,g,y;dv.svg.chart=c.append("svg:g").style("class","chart").attr("height",t).attr("width",n);dv.svg.paths=dv.svg.chart.append("svg:g").selectAll("path").data(s).attr("transform","translate("+e.left+",0)").enter().append("svg:path").attr("d",function(e){return dv.draw.flowLine(e)}).style("fill",function(e){return dv.scale.color(e.region)}).style("fill-opacity",i.norm).on("mouseover",function(e,t){w(event,e,t)}).on("mouseout",E);dv.svg.hover=d3.select("body").append("div").attr("class","hover");b("left");b("right");dv.svg.chart.selectAll("line").data(dv.data.years.selected).enter().append("svg:line").style("class","vertical-axis").style("stroke-width","1px").style("stroke-fill","#000").attr("x1",function(e){return dv.scale.x(e)}).attr("x2",function(e){return dv.scale.x(e)}).attr("y1",dv.dim.chart.h).attr("y2",dv.opt.margin.top)};dv.draw.flowLine=function(e){function p(e,t,n){n=n?" "+n:"";return n+e+","+t}var t=dv.data.years.selected,n=t.length,r=e.data,i=dv.dim.chart.h,s=e.offset,o=e.order,u=dv.opt.chart.line.pad,a="M",f=t[0],l,c,h;l=dv.scale.x(f);c=i-dv.scale.y(s[f])-dv.scale.ypow(r[f]);a+=p(l,c);for(h=0;h<n;h++){f=t[h];l=dv.scale.x(f);c=i-dv.scale.y(s[f])-o[f]*u;a+=p(l,c,"L")}c=i-dv.scale.y(s[f]);a+=p(l,c,"L");for(h=n-1;h>=0;h--){f=t[h];l=dv.scale.x(f);c=i-dv.scale.y(s[f])-o[f]*u-dv.scale.ypow(r[f]);a+=p(l,c,"L")}a+=" Z";return a};dv.calc.years=function(e,t){var n=[];for(var r=e;r<t+1;r++)n.push(r);return n};dv.util.sortByData=function(e){e.array.sort(function(t,n){return e.col?t.data[e.col][e.year]-n.data[e.col][e.year]:t.data[e.year]-n.data[e.year]});return e.array};dv.setup.withoutData();